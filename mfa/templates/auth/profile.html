{% extends 'mfa/base.html' %}
{% load static %}
{% block title %}Profile - {{ site_name }}{% endblock %}
{% block content %}
    {% include 'partials/navbar.html' %}
    <div class="container py-5">
      <div class="row justify-content-center">
        <div class="col-md-7 col-lg-5">
          <div class="card border shadow-lg p-4 text-center">
            <div class="text-right mb-1">
              <button type="button" class="btn btn-link p-0" data-toggle="modal" data-target="#genericSecurityNotesModal" title="Security notes" aria-label="Open security notes">
                <i class="fa fa-info-circle info-icon brand" aria-hidden="true" style="font-size: 1rem;"></i>
              </button>
            </div>
            <h2 class="h2Title mb-2"><span class="brand-color">P</span>rofile</h2>
            <p class="text-muted mb-3">Welcome back, {{ user.username }}.</p>
            <div class="d-flex justify-content-center mb-3">
              <div class="rounded-circle d-flex align-items-center justify-content-center text-white" style="background-color: var(--brand-color); width:84px;height:84px;font-size:2rem;">
                {{ user.username|first|upper }}
              </div>
            </div>
            <div class="text-left">
              <p class="mb-1"><strong>Username:</strong> {{ user.username }}</p>
              {% if user.email %}<p class="mb-1"><strong>Email:</strong> {{ user.email }}</p>{% endif %}
            </div>
            <div class="mt-3 text-left">
              <h6 class="mb-1 d-flex align-items-center">
                <i class="fas fa-shield-alt" style="color: var(--brand-color);" title="This key appears in our email footers. Use it to recognize official messages from us."></i>
                <span class="ml-1">Security key</span>
              </h6>
              <div class="d-flex align-items-center">
                <span class="badge bg-light text-dark border" id="safety-key-text" style="font-size: 0.9rem; padding: .35rem .5rem;">{{ safety_phrase }}</span>
                <button class="btn btn-sm btn-outline-secondary ml-2" type="button" id="copy-safety-key" title="Copy security key" aria-label="Copy security key">
                  <i class="fas fa-copy" aria-hidden="true"></i>
                </button>
              </div>
              <p class="text-muted d-block mt-1 mb-0">This key appears in our email footers. Use it to recognize official messages from us.</p>
            </div>
            {% if user.is_authenticated and not user.is_superuser and not has_google %}
            <div class="mt-4">
              <h5>Account Security</h5>
              <p>Manage your multi-factor authentication (MFA) settings to add an extra layer of protection to your account.</p>
              <a href="{% url 'mfa:security_hub' %}"
                 class="submitButton d-inline-block mt-2 text-decoration-none text-white"
                 aria-label="Go to Security Hub">
                 Go to Security Hub
              </a>
            </div>
            {% endif %}
            {% if user.is_authenticated %}
            <div class="mt-4 text-left">
              <h5>Open a Case</h5>
              <p class="mb-2">Report a security issue or suspicious activity. Our team will review it.</p>
              <form method="post" action="{% url 'mfa:open_case' %}">
                {% csrf_token %}
                <div class="form-group">
                  <label for="incident_type">Type</label>
                  <select id="incident_type" name="incident_type" class="form-control">
                    <option value="anomaly_detected">Anomaly Detected</option>
                    <option value="suspicious_login">Suspicious Login</option>
                    <option value="brute_force">Brute Force Attack</option>
                    <option value="threat_detected">Threat Detected</option>
                    <option value="device_fraud">Device Fraud</option>
                    <option value="location_anomaly">Location Anomaly</option>
                  </select>
                </div>
                <div class="form-group">
                  <label for="severity">Severity</label>
                  <select id="severity" name="severity" class="form-control">
                    <option value="low">Low</option>
                    <option value="medium" selected>Medium</option>
                    <option value="high">High</option>
                    <option value="critical">Critical</option>
                  </select>
                </div>
                <div class="form-group">
                  <label for="description">Description</label>
                  <textarea id="description" name="description" rows="3" class="form-control" placeholder="Briefly describe what happened" required></textarea>
                </div>
                <button type="submit" class="submitButton d-inline-block mt-2 text-decoration-none text-white">Open Case</button>
                <a href="{% url 'mfa:my_cases' %}" class="btn btn-link ml-2">My Cases</a>
              </form>
            </div>
            {% endif %}
            {% if user.is_staff %}
            <div class="mt-4 text-left">
              <h5 class="mb-2">Admin Shortcuts</h5>
              <div class="d-flex flex-wrap gap-2">
                <a class="btn btn-primary btn-sm mr-2 mb-2" href="{% url 'mfa:admin_dashboard' %}"><i class="fas fa-tachometer-alt mr-1"></i> Dashboard</a>
                <a class="btn btn-outline-secondary btn-sm mr-2 mb-2" href="{% url 'mfa:admin_users' %}"><i class="fas fa-users mr-1"></i> Users</a>
                <a class="btn btn-outline-secondary btn-sm mr-2 mb-2" href="{% url 'mfa:admin_logs' %}"><i class="fas fa-clipboard-list mr-1"></i> Logs</a>
                <a class="btn btn-outline-secondary btn-sm mr-2 mb-2" href="{% url 'mfa:admin_realtime_monitoring' %}"><i class="fas fa-broadcast-tower mr-1"></i> Real-time</a>
                <a class="btn btn-outline-secondary btn-sm mr-2 mb-2" href="{% url 'mfa:admin_risk_assessment' %}"><i class="fas fa-exclamation-triangle mr-1"></i> Risk</a>
                <a class="btn btn-outline-secondary btn-sm mr-2 mb-2" href="{% url 'mfa:admin_ml_risk_engine' %}"><i class="fas fa-robot mr-1"></i> ML Risk Engine</a>
                <a class="btn btn-outline-secondary btn-sm mr-2 mb-2" href="{% url 'mfa:admin_forensics_audit' %}"><i class="fas fa-microscope mr-1"></i> Forensics & Audit</a>
                <a class="btn btn-outline-secondary btn-sm mr-2 mb-2" href="{% url 'mfa:admin_incident_response' %}"><i class="fas fa-ambulance mr-1"></i> Incident Response</a>
                <a class="btn btn-outline-secondary btn-sm mr-2 mb-2" href="{% url 'mfa:admin_compliance_report' %}"><i class="fas fa-balance-scale mr-1"></i> Compliance</a>
                <a class="btn btn-outline-secondary btn-sm mr-2 mb-2" href="{% url 'mfa:admin_device_analytics' %}"><i class="fas fa-mobile-alt mr-1"></i> Device Analytics</a>
                <a class="btn btn-outline-secondary btn-sm mr-2 mb-2" href="{% url 'mfa:admin_notification_center' %}"><i class="fas fa-bell mr-1"></i> Notifications</a>
                <a class="btn btn-outline-secondary btn-sm mr-2 mb-2" href="{% url 'mfa:admin_session_management' %}"><i class="fas fa-user-clock mr-1"></i> Sessions</a>
                <a class="btn btn-outline-secondary btn-sm mr-2 mb-2" href="{% url 'mfa:admin_geolocation_tracking' %}"><i class="fas fa-globe-americas mr-1"></i> Geolocation</a>
                <a class="btn btn-outline-secondary btn-sm mr-2 mb-2" href="{% url 'mfa:admin_user_behavior_analytics' %}"><i class="fas fa-chart-line mr-1"></i> UBA</a>
                <a class="btn btn-outline-secondary btn-sm mr-2 mb-2" href="{% url 'mfa:admin_device_fingerprinting' %}"><i class="fas fa-fingerprint mr-1"></i> Fingerprinting</a>
                <a class="btn btn-outline-secondary btn-sm mr-2 mb-2" href="{% url 'mfa:admin_api_management' %}"><i class="fas fa-plug mr-1"></i> API Mgmt</a>
                <a class="btn btn-outline-secondary btn-sm mr-2 mb-2" href="{% url 'mfa:admin_enterprise_reporting' %}"><i class="fas fa-file-chart-line mr-1"></i> Reporting</a>
              </div>
            </div>
            {% endif %}
            <a href="{% url 'mfa:logout' %}" class="submitButton d-inline-block mt-3 text-decoration-none text-white">Logout</a>
          </div>
        </div>
      </div>
    </div>
    {% include 'partials/footer.html' %}
    <div class="modal fade" id="genericSecurityNotesModal" tabindex="-1" role="dialog" aria-labelledby="genericSecurityNotesLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title font-weight-bold" id="genericSecurityNotesLabel"><span class="brand-color">S</span>ecurity notes</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body text-left">
            <ul class="mb-0 pl-3" style="list-style: disc;">
              <li class="mb-1"><strong>Your Security Key</strong> is a short phrase we show here and in some emails. It should match.</li>
              <li class="mb-1"><strong>Keep codes private.</strong> We will never ask for your code or your Security Key.</li>
              <li class="mb-1"><strong>Only type codes on this website.</strong> Check the address bar and the lock (https) first.</li>
              <li class="mb-1"><strong>Verify the domain.</strong> Before entering a code, ensure the address bar shows our official domain.</li>
              <li class="mb-1"><strong>Not sure?</strong> Stop and contact support before continuing.</li>
            </ul>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-brand" data-dismiss="modal">Got it</button>
          </div>
        </div>
      </div>
    </div>
    <script>
      (function(){
        var btn = document.getElementById('copy-safety-key');
        var txt = document.getElementById('safety-key-text');
        if (!btn || !txt) return;
        function setStatus(ok){
          var icon = btn.querySelector('i');
          var orig = btn.getAttribute('data-orig-title') || btn.title || 'Copy security key';
          if (!btn.getAttribute('data-orig-title')) btn.setAttribute('data-orig-title', orig);
          if (ok){
            if (icon){ icon.classList.remove('fa-copy'); icon.classList.add('fa-check'); }
            btn.title = 'Copied';
          } else {
            btn.title = 'Press Ctrl+C to copy';
          }
          setTimeout(function(){
            if (icon){ icon.classList.remove('fa-check'); icon.classList.add('fa-copy'); }
            btn.title = btn.getAttribute('data-orig-title');
          }, 1500);
        }
        function fallbackCopy(text){
          var ta = document.createElement('textarea');
          ta.value = text;
          ta.style.position = 'fixed';
          ta.style.top = '-1000px';
          document.body.appendChild(ta);
          ta.select();
          var ok = false;
          try { ok = document.execCommand('copy'); } catch(e) { ok = false; }
          document.body.removeChild(ta);
          setStatus(ok);
        }
        btn.addEventListener('click', function(){
          var text = (txt && (txt.innerText || txt.textContent) || '').trim();
          if (!text) return;
          if (navigator.clipboard && navigator.clipboard.writeText){
            navigator.clipboard.writeText(text).then(function(){ setStatus(true); }, function(){ fallbackCopy(text); });
          } else {
            fallbackCopy(text);
          }
        });
      })();
</script>
{% endblock %}
