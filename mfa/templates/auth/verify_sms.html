{% extends 'mfa/base.html' %}
{% load static %}
{% block title %}Verify Your Identity - {{ site_name }}{% endblock %}
{% block content %}
    {% include 'partials/navbar.html' %}
    <div class="container py-5">
        <div class="row justify-content-center">
            <div class="col-md-7 col-lg-5">
                <div class="card border shadow-lg p-4">
                    <div class="text-right mb-1">
                        <button type="button" class="btn btn-link p-0" data-toggle="modal" data-target="#genericSecurityNotesModal" title="Security notes" aria-label="Open security notes">
                            <i class="fa fa-info-circle info-icon brand" aria-hidden="true" style="font-size: 1rem;"></i>
                        </button>
                    </div>
                    <h2 class="h2Title text-center mb-2" style="font-size: calc(1.9rem + 0.5vw) !important;"><span class="brand-color">V</span>erify Your Identity</h2>
                    <p class="text-center text-muted mb-3">A code will be sent to your registered phone number to complete your login.</p>
                    <div id="message-container"></div>
                    <div id="firebaseui-auth-container"></div>
                    <div id="loader" class="text-center d-none">Loading...</div>
                    <div class="mt-3 auth-helper text-center">
                        <a href="{% url 'mfa:choose_method' %}" class="brand-link">Try another method</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="genericSecurityNotesModal" tabindex="-1" role="dialog" aria-labelledby="genericSecurityNotesLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title font-weight-bold" id="genericSecurityNotesLabel"><span class="brand-color">S</span>ecurity notes</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body text-left">
            <ul class="mb-0 pl-3" style="list-style: disc;">
              <li class="mb-1"><strong>Your Security Key</strong> is a short phrase we show here and in some emails. It should match.</li>
              <li class="mb-1"><strong>Keep codes private.</strong> We will never ask for your code or your Security Key.</li>
              <li class="mb-1"><strong>Only type codes on this website.</strong> Check the address bar and the lock (https) first.</li>
              <li class="mb-1"><strong>Verify the domain.</strong> Before entering a code, ensure the address bar shows our official domain.</li>
              <li class="mb-1"><strong>Not sure?</strong> Stop and contact support before continuing.</li>
            </ul>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-brand" data-dismiss="modal">Got it</button>
          </div>
        </div>
      </div>
    </div>
    {% include 'partials/footer.html' %}
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/ui/6.0.1/firebase-ui-auth.js"></script>
    <link type="text/css" rel="stylesheet" href="https://www.gstatic.com/firebasejs/ui/6.0.1/firebase-ui-auth.css" />
    <script>
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_AUTH_DOMAIN",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_STORAGE_BUCKET",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID"
        };
        firebase.initializeApp(firebaseConfig);
        const messageContainer = document.getElementById('message-container');
        const uiConfig = {
            signInOptions: [
                {
                    provider: firebase.auth.PhoneAuthProvider.PROVIDER_ID,
                    defaultCountry: 'US',
                    recaptchaParameters: {
                        size: 'invisible'
                    }
                }
            ],
            callbacks: {
                signInSuccessWithAuthResult: function(authResult, redirectUrl) {
                    authResult.user.getIdToken().then(idToken => {
                        fetch('{% url "mfa:check_sms_login" %}', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': '{{ csrf_token }}'
                            },
                            body: JSON.stringify({ id_token: idToken })
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                showMessage('Login successful! Redirecting...', 'success');
                                window.location.href = data.redirect_url;
                            } else {
                                showMessage(`Login failed: ${data.error}`, 'danger');
                            }
                        }).catch(error => {
                            console.error('Error during fetch:', error);
                            showMessage(`An error occurred: ${error}`, 'danger');
                        });
                    });
                    return false;
                },
                uiShown: function() {
                    document.getElementById('loader').classList.add('d-none');
                }
            }
        };
        const ui = new firebaseui.auth.AuthUI(firebase.auth());
        ui.start('#firebaseui-auth-container', uiConfig);
        function showMessage(message, type) {
            messageContainer.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
        }
</script>
{% endblock %}
