{% extends 'mfa/base.html' %}
{% load static %}
{% load socialaccount %}
{% load widget_tweaks %}
{% block title %}Sign Up - {{ site_name }}{% endblock %}
{% block content %}
    {% include 'partials/navbar.html' %}
    <section class="auth-hero py-5 py-lg-5">
      <div class="container">
        <div class="row justify-content-center">
          <div class="col-lg-12">
            <div class="glass-frame hero-unified">
          <div class="row align-items-stretch no-gutters">
          <div class="col-lg-6 d-none d-lg-block d-flex pr-lg-0">
            <div class="auth-hero-copy frame-panel-left gradient-hero no-right-radius text-white rounded-3 p-4 pr-lg-5 pl-lg-5 py-lg-3 d-flex flex-column justify-content-center h-100 w-100">
              <div class="hero-body">
                <span class="badge badge-pill mb-3">Create</span>
                <h1 class="display-3 mb-3">Get started with your <span class="text-white-75">account</span></h1>
                <p class="text-white-75 mb-4">Fast sign up with strong security and privacy by default.</p>
                <ul class="list-unstyled small text-white-50 mb-0">
                  <li class="mb-2"><i class="fas fa-check mr-2 text-white"></i>Secure sessions & MFA</li>
                  <li class="mb-2"><i class="fas fa-check mr-2 text-white"></i>Single sign-on available</li>
                  <li><i class="fas fa-check mr-2 text-white"></i>Works on all your devices</li>
                </ul>
              </div>
            </div>
          </div>
          <div class="col-lg-6 d-flex pl-lg-0">
            <div class="frame-panel p-4 p-lg-4 signup-form-panel h-100 d-flex flex-column justify-content-center w-100">
              <div class="form-inner">
              <h2 class="h4 text-center mb-2 font-weight-bold"><span class="brand-color">S</span>ign Up</h2>
              <p class="text-center text-muted mb-3">Use Google or your details</p>
              <div class="mb-3">
                {% include 'auth/google_button.html' with button_text="Sign up with Google" %}
              </div>
              <div class="d-flex align-items-center my-3">
                <div class="flex-grow-1 border-top"></div>
                <span class="mx-2 text-muted small">or</span>
                <div class="flex-grow-1 border-top"></div>
              </div>
              {% if messages %}
                {% for message in messages %}
                  <div class="alert alert-{{ message.tags }} py-2 small" role="alert">{{ message }}</div>
                {% endfor %}
              {% endif %}
              <form method="post" novalidate data-captcha-error="Please complete the CAPTCHA to create your account.">
                {% csrf_token %}
                {% for field in form %}
                  <div class="mb-3">
                    <label class="form-label" for="{{ field.id_for_label }}">{{ field.label }}</label>
                    <div class="input-group input-group-elevated">
                      <div class="input-group-prepend">
                        {% if field.name == 'username' %}
                          <span class="input-group-text" aria-hidden="true"><i class="fa fa-user"></i></span>
                        {% elif field.name == 'email' %}
                          <span class="input-group-text" aria-hidden="true"><i class="fa fa-envelope"></i></span>
                        {% elif field.name == 'password1' or field.name == 'password2' %}
                          <span class="input-group-text" aria-hidden="true"><i class="fa fa-lock"></i></span>
                        {% else %}
                          <span class="input-group-text" aria-hidden="true"><i class="fa fa-pencil-alt"></i></span>
                        {% endif %}
                      </div>
                      {{ field|add_class:'form-control' }}
                    </div>
                    {% if field.help_text %}<div class="form-text">{{ field.help_text }}</div>{% endif %}
                    {% if field.errors %}
                      <div class="text-danger small mt-1">{{ field.errors|striptags }}</div>
                    {% endif %}
                  </div>
                {% endfor %}
                {% if recaptcha_site_key %}
                <div class="mb-3" data-no-invalid-icon>
                  <div class="g-recaptcha" data-sitekey="{{ recaptcha_site_key }}"></div>
                </div>
                {% elif turnstile_site_key %}
                {% if turnstile_site_key %}
                <div class="mb-3" data-no-invalid-icon>
                  <div class="cf-turnstile" data-sitekey="{{ turnstile_site_key }}"></div>
                </div>
                {% endif %}
                {% endif %}
                <button type="submit" class="submitButton w-100">Sign Up</button>
              </form>
              <div class="mt-3 auth-helper">
                <p class="mb-0 small">Already have an account? <a class="brand-link" href="{% url 'mfa:login' %}">Login</a></p>
              </div>
            </div>
              </div>
          </div>
        </div>
        </div>
      </div>
    </section>
    {% include 'partials/footer.html' %}
    {% if recaptcha_site_key %}
    <script src="https://www.google.com/recaptcha/enterprise.js" async defer></script>
    <noscript>
      <div class="alert alert-warning mt-2">JavaScript is disabled; reCAPTCHA cannot load.</div>
    </noscript>
    <script>
      window.addEventListener('load', function () {
        if (!window.grecaptcha) {
          console.warn('reCAPTCHA script not loaded on signup. Check blockers/CSP.');
          var box = document.createElement('div');
          box.className = 'alert alert-warning mt-2';
          box.textContent = 'reCAPTCHA script blocked or failed to load. Disable ad/script blockers for this page.';
          document.body.appendChild(box);
        }
      });
</script>
    {% elif turnstile_site_key %}
    <script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>
    {% endif %}
    <script>
      (function() {
        var form = document.querySelector('form');
        if (!form) return;
        function showClientError(input, message) {
          input.classList.add('is-invalid');
          var group = input.closest('.mb-3');
          if (!group) return;
          var holder = group.querySelector('.client-error');
          if (!holder) {
            holder = document.createElement('div');
            holder.className = 'text-danger small client-error';
            group.appendChild(holder);
          }
          holder.textContent = message;
        }
        function clearError(input) {
          input.classList.remove('is-invalid');
          var group = input.closest('.mb-3');
          if (group) {
            var holder = group.querySelector('.client-error');
            if (holder) holder.remove();
          }
        }
        form.addEventListener('submit', function(e) {
          var username = document.getElementById('id_username');
          var email = document.getElementById('id_email');
          var pwd1 = document.getElementById('id_password1');
          var pwd2 = document.getElementById('id_password2');
          var hasError = false;
          [username, email, pwd1, pwd2].forEach(function(inp) {
            if (!inp) return;
            clearError(inp);
            if (!inp.value || inp.value.trim() === '') {
              showClientError(inp, 'This field is required.');
              hasError = true;
            }
          });
          if (email && email.value) {
            var re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!re.test(email.value.trim())) {
              showClientError(email, 'Enter a valid email address.');
              hasError = true;
            }
          }
          if (pwd1 && pwd1.value && pwd1.value.length < 8) {
            showClientError(pwd1, 'Password must be at least 8 characters.');
            hasError = true;
          }
          if (pwd1 && pwd2 && pwd1.value && pwd2.value && pwd1.value !== pwd2.value) {
            showClientError(pwd2, 'Passwords do not match.');
            hasError = true;
          }
          // Enforce CAPTCHA like login (client-side guard; server still validates)
          if (!hasError) {
            var captchaErrorMsg = form.getAttribute('data-captcha-error') || 'Please complete the CAPTCHA.';
            var recaptchaBox = document.querySelector('.g-recaptcha');
            var turnstileBox = document.querySelector('.cf-turnstile');
            var captchaOk = true;
            if (recaptchaBox && window.grecaptcha && typeof window.grecaptcha.getResponse === 'function') {
              captchaOk = !!window.grecaptcha.getResponse();
              if (!captchaOk) {
                showClientError(recaptchaBox, captchaErrorMsg);
              }
            } else if (turnstileBox) {
              var tsInput = document.querySelector('input[name="cf-turnstile-response"]');
              captchaOk = !!(tsInput && tsInput.value);
              if (!captchaOk) {
                showClientError(turnstileBox, captchaErrorMsg);
              }
            }
            if (!captchaOk) {
              hasError = true;
            }
          }
          if (hasError) {
            e.preventDefault();
          }
        });
        document.addEventListener('input', function(e) {
          if (e.target && e.target.matches('#id_username, #id_email, #id_password1, #id_password2')) {
            clearError(e.target);
          }
        });
      })();
</script>
{% endblock %}
