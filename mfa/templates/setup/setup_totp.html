{% extends 'mfa/base.html' %}
{% load static %}
{% load widget_tweaks %}
{% block title %}Set up Authenticator - {{ site_name }}{% endblock %}
{% block content %}
    {% include 'partials/navbar.html' %}
    <div class="container py-5">
      <div class="row justify-content-center">
        <div class="col-md-10 col-lg-10">
          <div class="card border shadow-lg p-4">
            <h2 class="h2Title text-center mb-2" style="font-size: calc(1.9rem + 0.5vw) !important;"><span class="brand-color">S</span>et up your authenticator</h2>
            <p class="text-center text-muted mb-4">Scan the QR code below with Google Authenticator, Microsoft Authenticator, or any TOTP app. Then enter the 6‑digit code to confirm.</p>
            {% if messages %}
              {% for message in messages %}
                <div class="alert alert-{{ message.tags|default:'info' }} py-2 small" role="alert">{{ message }}</div>
              {% endfor %}
            {% endif %}
            <div class="row g-4 align-items-center">
              <div class="col-md-6">
                <div class="p-3 border rounded bg-light h-100">
                  <p class="mb-2"><strong>Manual key</strong></p>
                  <div class="d-flex align-items-center gap-2">
                    <code id="manual-key" class="d-block flex-grow-1 text-break">{{ secret }}</code>
                    <button type="button" class="btn btn-sm btn-outline-secondary" id="copy-key">
                      <i class="far fa-copy"></i> Copy
                    </button>
                  </div>
                  <p class="mt-3 small text-muted mb-0">If you can’t scan a QR, add the key manually. Issuer: <em>GreenShield</em>. Time‑based, 6 digits.</p>
                </div>
              </div>
              <div class="col-md-6">
                <div class="p-3 border rounded text-center h-100">
                  <p class="small text-muted mb-2">Scan with your app</p>
                  <div id="qr-code-container" style="min-height: 220px; display: flex; justify-content: center; align-items: center;">
                    <img id="qr-code" alt="QR code" class="img-fluid"
                         style="max-width: 220px; max-height: 220px; display: block;" />
                  </div>
                  <p id="qr-fallback" class="small text-danger mt-2" style="display: none;">
                    Having trouble with the QR code? Try the manual key below.
                  </p>
                </div>
              </div>
            </div>
            <form method="post" class="mt-4" novalidate>
              {% csrf_token %}
              <div class="mb-3" style="max-width: 360px;">
                {{ form.code.label_tag }}
                <div class="input-group">
                  <div class="input-group-prepend">
                    <span class="input-group-text" id="setup-totp-code-addon" aria-hidden="true"><i class="fa fa-key"></i></span>
                  </div>
                  {{ form.code|add_class:'form-control'|attr:'aria-describedby:setup-totp-code-addon' }}
                </div>
              </div>
              <button class="submitButton" type="submit">Confirm</button>
            </form>
          </div>
        </div>
      </div>
    </div>
    {% include 'partials/footer.html' %}
    <script>
      document.addEventListener('DOMContentLoaded', function() {
        const qrContainer = document.getElementById('qr-code-container');
        const qrImg = document.getElementById('qr-code');
        const qrFallback = document.getElementById('qr-fallback');
        if (qrImg && qrContainer) {
          const googleChartsUrl = `https://chart.googleapis.com/chart?cht=qr&chs=220x220&chld=L|0&chl={{ provisioning_uri|urlencode }}`;
          const tryAlternativeQR = () => {
            console.log('Trying alternative QR code service...');
            qrImg.src = `https://api.qrserver.com/v1/create-qr-code/?size=220x220&data={{ provisioning_uri|urlencode }}`;
            qrImg.onerror = null;
            qrFallback.style.display = 'block';
          };
          qrImg.onerror = tryAlternativeQR;
          qrImg.src = googleChartsUrl;
        }
        const copyBtn = document.getElementById('copy-key');
        const keyElement = document.getElementById('manual-key');
        if (copyBtn && keyElement) {
          copyBtn.addEventListener('click', async () => {
            try {
              const text = keyElement.textContent.trim();
              await navigator.clipboard.writeText(text);
              const originalHTML = copyBtn.innerHTML;
              copyBtn.innerHTML = '<i class="fas fa-check"></i> Copied!';
              copyBtn.classList.add('btn-success');
              copyBtn.classList.remove('btn-outline-secondary');
              setTimeout(() => {
                copyBtn.innerHTML = originalHTML;
                copyBtn.classList.remove('btn-success');
                copyBtn.classList.add('btn-outline-secondary');
              }, 2000);
            } catch (err) {
              console.error('Failed to copy text: ', err);
              copyBtn.innerHTML = '<i class="fas fa-times"></i> Failed';
              setTimeout(() => {
                copyBtn.innerHTML = '<i class="far fa-copy"></i> Copy';
              }, 2000);
            }
          });
        }
      });
</script>
{% endblock %}
