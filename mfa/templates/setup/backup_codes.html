{% extends 'mfa/base.html' %}
{% load static %}
{% block title %}Backup Codes - {{ site_name }}{% endblock %}
{% block content %}
  {% include 'partials/navbar.html' %}
    <div class="container py-5">
      <div class="row justify-content-center">
        <div class="col-md-7 col-lg-5">
          <div class="card border shadow-lg p-4">
            <h2 class="h2Title text-center mb-2" style="font-size: calc(1.9rem + 0.5vw) !important;">
              <span class="brand-color">B</span>ackup Codes
            </h2>
            <p class="text-center text-muted mb-3">These are single-use recovery codes. Save them in a secure place.</p>
            <div class="alert alert-warning mb-4" role="alert">
              <div class="d-flex align-items-start">
                <i class="fas fa-exclamation-triangle fa-fw mr-2 mt-1"></i>
                <div>
                  <strong>Important:</strong> Store these codes in a safe place. You will need them to access your account if you lose your device.
                </div>
              </div>
            </div>
            <div class="bg-light p-3 rounded mb-2">
              <div class="row g-2">
                {% for code in codes %}
                <div class="col-6">
                  <div class="d-flex align-items-center justify-content-between p-2 bg-white rounded shadow-sm">
                    <code class="font-monospace text-dark">{{ code }}</code>
                    <button type="button" class="btn btn-sm btn-outline-secondary copy-code ml-3" data-code="{{ code }}" title="Copy code">
                      <i class="far fa-copy"></i>
                    </button>
                  </div>
                </div>
                {% endfor %}
              </div>
            </div>
            <div class="d-flex justify-content-between align-items-center mb-4">
              <span class="badge bg-secondary">Total codes: {{ codes|length }}</span>
              <form method="post" action="">
                {% csrf_token %}
                <input type="hidden" name="regenerate" value="1" />
                <button type="submit" class="btn btn-outline-danger btn-sm">
                  <i class="fas fa-sync-alt mr-1"></i> Regenerate New Codes
                </button>
              </form>
            </div>
            <div class="d-flex flex-column gap-2 mb-4">
              <button type="button" class="btn btn-outline-primary" id="print-codes">
                <i class="fas fa-print mr-2"></i>Print Codes
              </button>
              <button type="button" class="btn btn-outline-success" id="download-codes">
                <i class="fas fa-download mr-2"></i>Download Codes
              </button>
            </div>
            <div class="text-center mt-4 pt-3 border-top">
              <form action="{% url 'mfa:profile' %}" method="get">
                <button type="submit" class="submitButton w-100">Done, Continue to Profile</button>
              </form>
            </div>
          </div>
        </div>
      </div>
    </div>
    {% include 'partials/footer.html' %}
    <script>
    document.addEventListener('DOMContentLoaded', function() {
      document.querySelectorAll('.copy-code').forEach(button => {
        button.addEventListener('click', function() {
          const code = this.getAttribute('data-code');
          navigator.clipboard.writeText(code).then(() => {
            const originalHTML = this.innerHTML;
            this.innerHTML = '<i class="fas fa-check text-white"></i>';
            this.classList.remove('btn-outline-secondary');
            this.classList.add('btn-success');
            setTimeout(() => {
              this.innerHTML = originalHTML;
              this.classList.remove('btn-success');
              this.classList.add('btn-outline-secondary');
            }, 2000);
          });
        });
      });
      document.getElementById('print-codes')?.addEventListener('click', function() {
        window.print();
      });
      document.getElementById('download-codes')?.addEventListener('click', function() {
        const codes = Array.from(document.querySelectorAll('[data-code]'))
          .map(el => el.getAttribute('data-code'));
        const blob = new Blob([
          'GreenShield - Backup Codes\n\n',
          'Generated on: ' + new Date().toLocaleDateString() + '\n\n',
          codes.join('\n'),
          '\n\nImportant: Store this file in a secure location. Do not share these codes with anyone.'
        ], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'greenshield-backup-codes.txt';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      });
    });
</script>
{% endblock %}
