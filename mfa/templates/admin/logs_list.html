{% extends 'admin/admin_base.html' %}
{% load static %}
{% block admin_title %}MFA Logs{% endblock %}
{% block admin_page_name %}Logs{% endblock %}
{% block admin_content %}
  <div class="container py-5">
    <div class="row justify-content-center">
      <div class="col-12">
        <div class="glass-frame hero-unified mb-4 rounded-3">
          <div class="row align-items-stretch no-gutters">
            <div class="col-12 d-flex pr-lg-0">
              <div class="auth-hero-copy frame-panel-left gradient-hero admin-hero text-white rounded-3 p-4 pr-lg-5 pl-lg-5 py-lg-3 d-flex flex-column justify-content-center h-100 w-100">
                <div class="hero-body">
                  <span class="badge badge-pill mb-3">Admin</span>
                  <h1 class="display-5 mb-2">Logs</h1>
                  <p class="text-white-75 mb-0">Browse MFA audit logs with filters and pagination.</p>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="card shadow-sm">
          <div class="card-body">
            <div class="section-header section-header-on-green d-flex justify-content-between align-items-center mb-3">
              <h5 class="mb-0 text-white">MFA Logs</h5>
            </div>

            <form method="get" class="mb-3 filters-form" role="search" aria-label="Filter logs" novalidate data-no-client-validate>
              <div class="filters-toolbar p-3 mb-3">
              <h6 class="filters-title mb-2">Filters</h6>
              <div class="row g-3 align-items-end">
                <div class="col-12 col-sm-6 col-lg-4">
                  <label class="form-label small mb-1">Search</label>
                  <div class="input-group input-group-sm">
                    <div class="input-group-prepend">
                      <span class="input-group-text" aria-hidden="true"><i class="fa fa-search"></i></span>
                    </div>
                    <input type="text" class="form-control" name="q" value="{{ filters.q }}" placeholder="user, event, method, IP, details..." />
                  </div>
                </div>
                <div class="col-6 col-sm-6 col-lg-2">
                  <label class="form-label small mb-1">Outcome</label>
                  <div class="input-group input-group-sm">
                    <div class="input-group-prepend">
                      <span class="input-group-text" aria-hidden="true"><i class="fa fa-check-circle"></i></span>
                    </div>
                    <select name="outcome" class="form-control">
                      <option value="" {% if not filters.outcome %}selected{% endif %}>All</option>
                      <option value="successes" {% if filters.outcome == 'successes' %}selected{% endif %}>Successes</option>
                      <option value="failures" {% if filters.outcome == 'failures' %}selected{% endif %}>Failures</option>
                    </select>
                  </div>
                </div>
                <div class="col-6 col-sm-6 col-lg-2">
                  <label class="form-label small mb-1">User</label>
                  <div class="input-group input-group-sm">
                    <div class="input-group-prepend">
                      <span class="input-group-text" aria-hidden="true"><i class="fa fa-user"></i></span>
                    </div>
                    <input type="text" class="form-control" name="user" value="{{ filters.user }}" placeholder="username" />
                  </div>
                </div>
                <div class="col-6 col-sm-6 col-lg-2">
                  <label class="form-label small mb-1">IP</label>
                  <div class="input-group input-group-sm">
                    <div class="input-group-prepend">
                      <span class="input-group-text" aria-hidden="true"><i class="fa fa-globe"></i></span>
                    </div>
                    <input type="text" class="form-control" name="ip" value="{{ filters.ip }}" placeholder="IP" />
                  </div>
                </div>
                <div class="col-6 col-sm-6 col-lg-2">
                  <label class="form-label small mb-1">Date Range</label>
                  <div class="input-group input-group-sm">
                    <div class="input-group-prepend">
                      <span class="input-group-text" aria-hidden="true"><i class="fa fa-calendar-alt"></i></span>
                    </div>
                    <select class="form-control" name="range" aria-label="Quick range">
                      <option value="" {% if not filters.range %}selected{% endif %}>Custom</option>
                      <option value="today" {% if filters.range == 'today' %}selected{% endif %}>Today</option>
                      <option value="7d" {% if filters.range == '7d' %}selected{% endif %}>Last 7 days</option>
                      <option value="30d" {% if filters.range == '30d' %}selected{% endif %}>Last 30 days</option>
                      <option value="90d" {% if filters.range == '90d' %}selected{% endif %}>Last 90 days</option>
                    </select>
                  </div>
                </div>
              </div>
              <div class="row g-3 align-items-end mt-0">
                <div class="col-6 col-sm-6 col-lg-2">
                  <label class="form-label small mb-1">From</label>
                  <div class="input-group input-group-sm">
                    <div class="input-group-prepend">
                      <span class="input-group-text" aria-hidden="true"><i class="fa fa-calendar"></i></span>
                    </div>
                    <input type="date" class="form-control" name="from" value="{{ filters.from }}" />
                  </div>
                </div>
                <div class="col-6 col-sm-6 col-lg-2">
                  <label class="form-label small mb-1">To</label>
                  <div class="input-group input-group-sm">
                    <div class="input-group-prepend">
                      <span class="input-group-text" aria-hidden="true"><i class="fa fa-calendar"></i></span>
                    </div>
                    <input type="date" class="form-control" name="to" value="{{ filters.to }}" />
                  </div>
                </div>
              </div>
              <div class="row g-3 mt-2 align-items-end">
                <div class="col-6 col-md-2">
                  <label class="form-label small mb-1">Sort</label>
                  <select name="sort" class="form-control form-control-sm">
                    {% for val,label in sort_options %}
                      <option value="{{ val }}" {% if filters.sort == val %}selected{% endif %}>{{ label }}</option>
                    {% endfor %}
                  </select>
                </div>
                <div class="col-6 col-md-2">
                  <label class="form-label small mb-1">Order</label>
                  <select name="order" class="form-control form-control-sm">
                    <option value="desc" {% if filters.order == 'desc' %}selected{% endif %}>Desc</option>
                    <option value="asc" {% if filters.order == 'asc' %}selected{% endif %}>Asc</option>
                  </select>
                </div>
                <div class="col-12 col-md-3 col-lg-2">
                  <label class="form-label small mb-1">Page size</label>
                  <select name="page_size" class="form-control form-control-sm">
                    {% for size in page_size_options %}
                      <option value="{{ size }}" {% if page_size == size %}selected{% endif %}>{{ size }}</option>
                    {% endfor %}
                  </select>
                </div>
                <div class="col-12 col-md d-flex justify-content-md-end align-items-end">
                  <div class="d-flex flex-wrap toolbar-actions mt-3">
                    <button type="button" id="btnClearFilters" class="btn btn-outline-secondary btn-sm mr-2 mb-2" title="Clear all filters">Clear Filters</button>
                    <button type="reset" class="btn btn-outline-secondary btn-sm mr-2 mb-2">Reset</button>
                    <a href="?{{ request.META.QUERY_STRING }}&export=csv" class="btn btn-outline-secondary btn-sm mr-2 mb-2">Export CSV</a>
                    <button type="submit" class="btn btn-success btn-sm btn-brand mb-2">Apply</button>
                  </div>
                </div>
              </div>
              </div>
              <div class="row g-3 align-items-stretch mt-2">
                <div class="col-12 col-lg-5 d-flex">
                  <div class="filter-box d-flex flex-column w-100">
                    <label class="form-label mb-1"><i class="fas fa-fingerprint me-1 text-muted" aria-hidden="true"></i> Methods <span class="text-muted selected-count" id="methodsCount"></span></label>
                    <input type="search" class="form-control form-control-sm mb-2 js-filter-list" data-target="#methodsList" placeholder="Search methods..." aria-label="Search methods" />
                    <div id="methodsPills" class="selected-pills mb-2" aria-live="polite"></div>
                    <div class="d-flex justify-content-between align-items-center mb-2">
                      <small class="text-muted">Choose one or more methods</small>
                      <div class="filter-actions">
                        <button type="button" class="btn btn-link btn-link-compact p-0 js-check-all" data-target="#methodsList">Select all</button>
                        <span class="text-muted">·</span>
                        <button type="button" class="btn btn-link btn-link-compact p-0 js-uncheck-all" data-target="#methodsList">Clear</button>
                      </div>
                    </div>
                    <div id="methodsList" class="option-list" role="group" aria-label="Methods">
                      {% for val,label in available_method_options %}
                        <label class="option-item">
                          <input type="checkbox" name="methods" value="{{ val }}" {% if filters.methods and val in filters.methods %}checked{% endif %} />
                          <span class="option-text" data-text="{{ label|lower }}">{{ label }}</span>
                        </label>
                      {% endfor %}
                    </div>
                  </div>
                </div>
                <div class="col-12 col-lg-7 d-flex">
                  <div class="filter-box d-flex flex-column w-100">
                    <label class="form-label mb-1"><i class="fas fa-bolt me-1 text-muted" aria-hidden="true"></i> Events <span class="text-muted selected-count" id="eventsCount"></span></label>
                    <input type="search" class="form-control form-control-sm mb-2 js-filter-list" data-target="#eventsList" placeholder="Search events..." aria-label="Search events" />
                    <div id="eventsPills" class="selected-pills mb-2" aria-live="polite"></div>
                    <div class="d-flex justify-content-between align-items-center mb-2">
                      <small class="text-muted">Choose one or more events</small>
                      <div class="filter-actions">
                        <button type="button" class="btn btn-link btn-link-compact p-0 js-check-all" data-target="#eventsList">Select all</button>
                        <span class="text-muted">·</span>
                        <button type="button" class="btn btn-link btn-link-compact p-0 js-uncheck-all" data-target="#eventsList">Clear</button>
                      </div>
                    </div>
                    <div id="eventsList" class="option-list" role="group" aria-label="Events">
                      {% for val,label in available_event_options %}
                        <label class="option-item">
                          <input type="checkbox" name="events" value="{{ val }}" {% if filters.events and val in filters.events %}checked{% endif %} />
                          <span class="option-text" data-text="{{ label|lower }}">{{ label }}</span>
                        </label>
                      {% endfor %}
                    </div>
                  </div>
                </div>
              </div>
              
            </form>

            <!-- Top pagination removed to match users page design -->

            <div id="logsResults" aria-live="polite">
            <div class="table-responsive">
              <table class="table table-sm table-hover align-middle">
                <thead>
                  <tr>
                    <th style="width: 200px;">When</th>
                    <th>User</th>
                    <th>Event</th>
                    <th>Method</th>
                    <th>Outcome</th>
                    <th>IP</th>
                    <th class="d-none d-lg-table-cell">User Agent</th>
                  </tr>
                </thead>
                <tbody>
                  {% for log in logs %}
                    <tr>
                      <td>{{ log.created_at|date:'Y-m-d H:i:s' }}</td>
                      <td>
                        {% if log.user %}
                          <a href="{% url 'mfa:admin_user_detail' log.user.id %}" class="user-link">{{ log.user.username }}</a>
                          {% if log.user.is_superuser %}
                            <span class="badge bg-danger">superuser</span>
                          {% elif log.user.is_staff %}
                            <span class="badge bg-secondary">staff</span>
                          {% endif %}
                        {% else %}
                          <span class="text-muted">-</span>
                        {% endif %}
                      </td>
                      <td><span class="badge bg-light text-dark" style="font-weight:600;">{{ log.get_event_display|default:log.event }}</span></td>
                      <td>{{ log.method_display|default:'-' }}</td>
                      <td>
                        {% if log.outcome == 'success' %}
                          <span class="badge bg-success">Success</span>
                        {% elif log.outcome == 'failure' %}
                          <span class="badge bg-danger">Failure</span>
                        {% else %}
                          <span class="badge bg-secondary">Other</span>
                        {% endif %}
                      </td>
                      <td>{{ log.ip_address|default:'-' }}</td>
                      <td class="d-none d-lg-table-cell">{{ log.user_agent|default:'-' }}</td>
                    </tr>
                  {% empty %}
                    <tr><td colspan="7" class="text-muted">No logs found.</td></tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>

            <nav class="d-flex justify-content-center align-items-center gap-2 mt-2">
              <ul class="pagination pagination-sm mb-0">
                <li class="page-item {% if page <= 1 %}disabled{% endif %}"><a class="page-link" href="?page={{ page|add:'-1' }}&page_size={{ page_size }}&outcome={{ filters.outcome }}&user={{ filters.user }}&q={{ filters.q }}&ip={{ filters.ip }}&range={{ filters.range }}&from={{ filters.from }}&to={{ filters.to }}&sort={{ filters.sort }}&order={{ filters.order }}{% for m in filters.methods %}&methods={{ m }}{% endfor %}{% for e in filters.events %}&events={{ e }}{% endfor %}">Prev</a></li>
                <li class="page-item disabled"><span class="page-link">Page {{ page }} of {{ total_pages }}</span></li>
                <li class="page-item {% if page >= total_pages %}disabled{% endif %}"><a class="page-link" href="?page={{ page|add:'1' }}&page_size={{ page_size }}&outcome={{ filters.outcome }}&user={{ filters.user }}&q={{ filters.q }}&ip={{ filters.ip }}&range={{ filters.range }}&from={{ filters.from }}&to={{ filters.to }}&sort={{ filters.sort }}&order={{ filters.order }}{% for m in filters.methods %}&methods={{ m }}{% endfor %}{% for e in filters.events %}&events={{ e }}{% endfor %}">Next</a></li>
              </ul>
            </nav>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
{% endblock %}
{% block extra_css %}
  {{ block.super }}
  <style>
    .section-header-on-green {
      background: linear-gradient(135deg, rgba(118,185,87,0.98) 0%, rgba(63,111,44,0.98) 100%);
      color: #ffffff !important;
      margin: -1.25rem -1.25rem 0 -1.25rem; /* match .card-body padding */
      padding: 1.25rem 1.5rem;
      border-radius: 0.375rem 0.375rem 0 0;
      overflow: hidden;
      min-height: 60px;
    }
    .section-header-on-green h5 { color:#fff !important; margin:0; font-weight:600; }
    .btn-brand { color:#fff; background-color: var(--brand-color, #55833d); border-color: var(--brand-color, #55833d); box-shadow:none !important; }
    .btn-brand:hover, .btn-brand:focus { color:#fff; background-color:#446a32; border-color:#3e612d; }
    .table thead th { background:#f8fafb; border-top:none; color:#475569; }
    .table tbody tr:hover { background:#fcfdfd; }
    /* Ensure horizontal scroll is available and content not cut */
    .table-responsive { overflow-x: auto; -webkit-overflow-scrolling: touch; }
    .table { min-width: 1100px; }
    .table th, .table td { white-space: nowrap; }

    /* Filters: unified compact sizing and neutralize validation visuals */
    .filters-form .form-control.form-control-sm,
    .filters-form .form-select.form-select-sm { height: 34px; min-height: 34px; padding: .375rem .55rem; font-size: .95rem; }
    /* Input groups (icons) compact look */
    .filters-form .input-group.input-group-sm .input-group-text { height: 34px; min-height: 34px; padding: .375rem .55rem; font-size: .95rem; background: #fff; border-color:#ced4da; color:#64748b; }
    .filters-form .input-group { flex-wrap: nowrap; }
    .filters-form .input-group .form-control { height: 34px; min-height: 34px; padding: .375rem .55rem; }
    /* Avoid collapsed date inputs showing a dot */
    .filters-form input[type="date"] { min-width: 7.2rem; }
    @media (min-width: 576px) {
      .filters-form input[type="date"] { min-width: 8.5rem; }
    }
    /* Make date inputs visually match text inputs by hiding native picker icon (all engines) */
    .filters-form input[type="date"] { appearance: none; -webkit-appearance: none; -moz-appearance: textfield; background-image: none; }
    .filters-form input[type="date"]::-webkit-calendar-picker-indicator { opacity: 0; display: none; }
    .filters-form input[type="date"]::-webkit-inner-spin-button { display: none; }
    .filters-form input[type="date"]::-ms-clear, 
    .filters-form input[type="date"]::-ms-reveal { display: none; }
    /* Inline icon inside inputs */
    .filters-form .icon-input { position: relative; }
    .filters-form .icon-input .field-icon { position: absolute; left: .55rem; top: 50%; transform: translateY(-50%); color: #64748b; pointer-events: none; font-size: .95rem; }
    .filters-form .icon-input .form-control { padding-left: 2rem; height: 34px; min-height: 34px; }
    /* Right-side bordered icon box (like input-group-append) */
    .filters-form .icon-input.right .form-control { padding-left: .55rem; padding-right: 2.2rem; }
    .filters-form .icon-input.right .field-icon-box {
      position: absolute; right: 0; top: 0; bottom: 0; width: 2.1rem;
      display: inline-flex; align-items: center; justify-content: center;
      background: #fff; color: #64748b; border-left: 1px solid #ced4da;
      border-top-right-radius: .25rem; border-bottom-right-radius: .25rem;
      pointer-events: none; /* keep native date picker clickable */
      font-size: .95rem;
    }
    /* Unify borders for all controls in this filters form */
    .filters-form .form-control,
    .filters-form .form-select { border-color:#ced4da; border-radius:.25rem; }
    .filters-form .is-invalid { border-color: #ced4da !important; box-shadow: none !important; }
    .filters-form .client-error, .filters-form .invalid-icon { display: none !important; }
    .filters-form label.form-label { margin-bottom: .2rem; color: #475569; }
    .filters-form .btn { box-shadow: none !important; }
    /* Make Filters title bold */
    .filters-title { font-weight: 700; }

    /* Filter box: organized look aligned with BS4.6 */
    .filter-box { border: 1px solid #ced4da; background: #fbfcfd; border-radius: .25rem; padding: .75rem; box-shadow: 0 1px 2px rgba(16,24,40,.04); overflow: hidden; }
    .filter-box .form-control { box-shadow: none !important; background: #fff; }
    .filter-box .input-group-text { background:#fff; border-color:#ced4da; }
    /* Unify borders and radii inside filters */
    .filter-box,
    .filter-box .option-list,
    .filter-box .form-control,
    .filter-box .form-select {
      border-color: #ced4da !important;
      border-width: 1px;
      border-radius: .25rem;
    }
    .btn-link-compact { color: #64748b; font-weight: 600; font-size: .85rem; white-space: nowrap; }
    .btn-link-compact:hover { color: #334155; text-decoration: underline; }
    .filter-actions { display: flex; align-items: center; gap: .4rem; flex-wrap: nowrap; white-space: nowrap; }
    .filter-actions .text-muted { font-size: .85rem; margin: 0 .4rem; }
    .filter-actions .btn-link-compact + .btn-link-compact { margin-left: .4rem; }
    /* Large, readable checkbox lists (shorter, equal height) */
    .option-list { height: 260px; overflow: auto; border: 1px solid #ced4da; background: #fff; border-radius: .25rem; padding: .25rem; }
    .option-item { display: flex; align-items: center; gap: .6rem; padding: .5rem .55rem; border-radius: .3rem; font-size: 1.02rem; }
    .option-item:hover { background: #f8fafb; }
    .option-item input[type="checkbox"] { transform: scale(1.1); margin: 0; }
    .option-text { line-height: 1.2; }
    /* Pills showing selections */
    .selected-pills { display: flex; flex-wrap: wrap; gap: .4rem; }
    .selected-pills .pill { display: inline-flex; align-items: center; gap: .35rem; padding: .2rem .55rem; background: #eef3f6; border: 1px solid #ced4da; border-radius: 999px; font-size: .88rem; color: #334155; }
    .selected-pills .pill .remove { cursor: pointer; color: #64748b; }
    .selected-pills .pill .remove:hover { color: #0f172a; }
    .filter-box label.form-label { font-weight: 600; color: #334155; }
    /* BS4.6-like focus ring for inputs/selects within filters */
    .filter-box .form-control:focus,
    .filter-box .form-select:focus { border-color: #80bdff; outline: 0; box-shadow: 0 0 0 .2rem rgba(0,123,255,.15); }
    @media (max-width: 576.98px){
      .filter-actions { justify-content: flex-start; margin-top: .15rem; }
      .option-list { height: 220px; }
      .filters-form input[type="date"] { min-width: 0; }
    }
  </style>
{% endblock %}
{% block extra_js %}
  {{ block.super }}
  <script>
    (function(){
      var form = document.querySelector('form.filters-form[role="search"]');
      if (!form) return;
      // Clear any previous invalid markers left from earlier sessions
      form.querySelectorAll('.is-invalid').forEach(function(el){ el.classList.remove('is-invalid'); });
      form.querySelectorAll('.invalid-icon, .client-error').forEach(function(el){ el.remove(); });

      // Search-as-you-type for checkbox lists
      function setupFilterList(input){
        var container = document.querySelector(input.getAttribute('data-target'));
        if (!container) return;
        var items = Array.prototype.slice.call(container.querySelectorAll('.option-item'));
        items.forEach(function(li){
          var txt = (li.querySelector('.option-text')?.dataset.text || '').toLowerCase();
          li.dataset.text = txt;
        });
        function apply(){
          var q = (input.value||'').trim().toLowerCase();
          items.forEach(function(li){ li.style.display = (!q || li.dataset.text.indexOf(q) > -1) ? '' : 'none'; });
        }
        input.addEventListener('input', apply);
        apply();
      }
      form.querySelectorAll('.js-filter-list').forEach(setupFilterList);

      // Select all respects filter; Clear removes all selections (even hidden)
      function bulkCheck(containerSelector, checked, onlyVisible){
        var c = document.querySelector(containerSelector); if (!c) return;
        c.querySelectorAll('.option-item').forEach(function(li){
          if (onlyVisible && li.style.display === 'none') return; // optionally respect current filter
          var box = li.querySelector('input[type="checkbox"]');
          if (box && box.checked !== !!checked){
            box.checked = !!checked;
          }
        });
        // refresh pills/counts after bulk change and apply
        update();
        applyNow();
      }
      form.querySelectorAll('.js-check-all').forEach(function(b){ b.addEventListener('click', function(){ bulkCheck(b.getAttribute('data-target'), true, true); }); });
      form.querySelectorAll('.js-uncheck-all').forEach(function(b){ b.addEventListener('click', function(){ bulkCheck(b.getAttribute('data-target'), false, false); }); });

      // Selected counts + pills
      function syncSelected(containerSel, pillsId, countId){
        var c = document.querySelector(containerSel); if (!c) return;
        var pills = document.getElementById(pillsId);
        var countEl = document.getElementById(countId);
        var checked = Array.prototype.slice.call(c.querySelectorAll('input[type="checkbox"]:checked'));
        var labels = checked.map(function(cb){ var t = cb.closest('.option-item').querySelector('.option-text').textContent.trim(); return { value: cb.value, text: t }; });
        if (countEl) countEl.textContent = labels.length ? '(' + labels.length + ' selected)' : '';
        if (!pills) return;
        pills.innerHTML = '';
        var max = 6;
        labels.slice(0, max).forEach(function(it){
          var el = document.createElement('span');
          el.className = 'pill';
          el.innerHTML = '<span>'+it.text+'</span><span class="remove" aria-label="Remove" title="Remove">×</span>';
          el.querySelector('.remove').addEventListener('click', function(){
            var box = c.querySelector('input[type="checkbox"][value="'+CSS.escape(it.value)+'"]');
            if (box){ box.checked = false; update(); applyNowDebounced(); }
          });
          pills.appendChild(el);
        });
        if (labels.length > max){
          var more = document.createElement('span'); more.className='pill'; more.textContent = '+'+(labels.length-max)+' more'; pills.appendChild(more);
        }
      }
      function update(){
        syncSelected('#methodsList','methodsPills','methodsCount');
        syncSelected('#eventsList','eventsPills','eventsCount');
      }
      form.addEventListener('change', function(e){
        if (e.target && e.target.matches('.option-list input[type="checkbox"]')){
          update();
          applyNowDebounced();
        }
      });
      update();

      // Clear all filters (non-destructive to page size and sort unless desired)
      var clearBtn = document.getElementById('btnClearFilters');
      if (clearBtn){
        clearBtn.addEventListener('click', function(){
          // text inputs
          form.querySelectorAll('input[type="text"], input[type="search"], input[type="date"], input[type="number"]').forEach(function(i){ i.value=''; });
          // selects -> first option
          form.querySelectorAll('select').forEach(function(s){ if (s.name !== 'page_size' && s.name !== 'sort' && s.name !== 'order') { s.selectedIndex = 0; } });
          // checkbox lists
          form.querySelectorAll('.option-list input[type="checkbox"]').forEach(function(cb){ cb.checked = false; });
          // Reapply filters on lists
          form.querySelectorAll('.js-filter-list').forEach(function(inp){ inp.dispatchEvent(new Event('input')); });
          update();
          applyNow();
        });
      }

      // --- AJAX helpers: load results without full refresh ---
      var resultsWrap = document.getElementById('logsResults');
      function applyNow(){
        var params = serializeForm(form);
        // Reset pagination when filters change
        params.delete('page');
        var url = window.location.pathname + '?' + params.toString();
        loadResults(url, true);
      }
      function serializeForm(f){
        var fd = new FormData(f);
        // Ensure unchecked checkboxes already excluded; include multiple values
        var params = new URLSearchParams();
        fd.forEach(function(v,k){ params.append(k, v); });
        return params;
      }
      function extractResults(html){
        var parser = new DOMParser();
        var doc = parser.parseFromString(html, 'text/html');
        return doc.getElementById('logsResults');
      }
      // Debounce helper for auto-apply
      function debounce(fn, wait){ var t; return function(){ clearTimeout(t); var self=this, args=arguments; t=setTimeout(function(){ fn.apply(self, args); }, wait); }; }
      var applyNowDebounced = debounce(applyNow, 250);
      function bindResultsHandlers(){
        if (!resultsWrap) return;
        // Intercept pagination clicks
        resultsWrap.querySelectorAll('.pagination a.page-link').forEach(function(a){
          a.addEventListener('click', function(ev){
            // allow export or disabled
            if (a.closest('.page-item')?.classList.contains('disabled')) return ev.preventDefault();
            ev.preventDefault();
            var url = new URL(a.href, window.location.origin);
            // Merge current form state into the clicked pagination URL, preserving page
            var current = serializeForm(form);
            var merged = new URLSearchParams(url.search);
            // keep page from pagination, overlay everything else from form
            current.forEach(function(v,k){ if (k !== 'page') { merged.delete(k); merged.append(k, v); } });
            url.search = merged.toString();
            loadResults(url.toString(), true);
          });
        });
      }
      function loadResults(url, push){
        if (!resultsWrap) return;
        resultsWrap.setAttribute('aria-busy','true');
        fetch(url, { headers: { 'X-Requested-With': 'XMLHttpRequest' } })
          .then(function(r){ return r.text(); })
          .then(function(html){
            var newResults = extractResults(html);
            if (!newResults) return;
            resultsWrap.innerHTML = newResults.innerHTML;
            resultsWrap.removeAttribute('aria-busy');
            if (push) history.pushState({ ajax: true }, '', url);
            // rebind pagination inside new content
            bindResultsHandlers();
          })
          .catch(function(){ resultsWrap.removeAttribute('aria-busy'); });
      }
      // Intercept form submit (Apply)
      form.addEventListener('submit', function(ev){
        ev.preventDefault();
        var params = serializeForm(form);
        var url = window.location.pathname + '?' + params.toString();
        loadResults(url, true);
      });
      // Handle browser navigation
      window.addEventListener('popstate', function(){ loadResults(location.href, false); });
      // Initial bind
      bindResultsHandlers();
    })();
  </script>
{% endblock %}
