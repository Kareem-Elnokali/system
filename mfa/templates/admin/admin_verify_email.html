{% extends 'mfa/base.html' %}
{% load static %}
{% block title %}Admin Email Verification - {{ site_name }}{% endblock %}
{% block content %}
    {% include 'partials/navbar.html' %}
    <div class="container py-5">
      <div class="row justify-content-center">
        <div class="col-md-7 col-lg-5">
          <div class="card border shadow-lg p-4">
            <div class="text-right mb-1">
              <button type="button" class="btn btn-link p-0" data-toggle="modal" data-target="#genericSecurityNotesModal" title="Security notes" aria-label="Open security notes">
                <i class="fa fa-info-circle info-icon brand" aria-hidden="true" style="font-size: 1rem;"></i>
              </button>
            </div>
            <h2 class="h2Title text-center mb-2" style="font-size: calc(1.9rem + 0.5vw) !important;"><span class="brand-color">E</span>mail Verification</h2>
            <p class="text-center text-muted mb-2">Enter the code sent to your email</p>
            {% if messages %}
              {% for message in messages %}
                <div class="alert alert-{{ message.tags }} py-2 small" role="alert">{{ message }}</div>
              {% endfor %}
            {% endif %}
            <form method="post" novalidate id="admin-otp-form">
              {% csrf_token %}
              {% if next %}
                <input type="hidden" name="next" value="{{ next }}" />
              {% endif %}
              <div class="mb-3 text-left">
                <div class="mx-auto" style="max-width: 320px;">
                  <div class="d-flex justify-content-between" style="gap:8px;">
                  <input inputmode="numeric" pattern="\d*" maxlength="1" class="form-control text-center otp-box" id="admin-otp-1" aria-label="Digit 1" />
                  <input inputmode="numeric" pattern="\d*" maxlength="1" class="form-control text-center otp-box" id="admin-otp-2" aria-label="Digit 2" />
                  <input inputmode="numeric" pattern="\d*" maxlength="1" class="form-control text-center otp-box" id="admin-otp-3" aria-label="Digit 3" />
                  <input inputmode="numeric" pattern="\d*" maxlength="1" class="form-control text-center otp-box" id="admin-otp-4" aria-label="Digit 4" />
                  <input inputmode="numeric" pattern="\d*" maxlength="1" class="form-control text-center otp-box" id="admin-otp-5" aria-label="Digit 5" />
                  <input inputmode="numeric" pattern="\d*" maxlength="1" class="form-control text-center otp-box" id="admin-otp-6" aria-label="Digit 6" />
                  </div>
                </div>
                <input type="hidden" name="{{ form.code.name }}" id="{{ form.code.id_for_label }}-hidden" />
                <small class="form-text text-muted">Check your email for the 6-digit code (it may take a few minutes)</small>
              </div>
              <button type="submit" class="submitButton w-100">Verify & Access Admin</button>
            </form>
            <div class="mt-3 text-center">
              <a class="brand-link disabled" id="resend-link" aria-disabled="true" tabindex="-1">Resend code in <span id="resend-timer">45</span>s</a>
            </div>
            {% if safety_phrase %}
            <div class="mx-auto my-2" style="max-width:260px;">
              <div class="border rounded small p-1 px-2 d-flex align-items-center justify-content-between" style="background:#f6f9fc; font-size: 0.85rem; line-height:1;">
                <div class="d-flex align-items-center">
                  <i class="fa fa-shield-alt mr-1" aria-hidden="true" style="font-size:0.9rem; color: var(--brand-color);"></i>
                  <span class="text-muted">Security key:</span>
                  <strong class="ml-1 text-dark">{{ safety_phrase }}</strong>
                </div>
                <i class="fa fa-info-circle info-icon ml-1" aria-hidden="true" title="This Security Key helps you spot phishing. The key shown here should match the one in the email you received." style="font-size: 0.8rem; line-height:1;"></i>
              </div>
            </div>
            {% endif %}
            <div class="mt-4 text-center">
              <a href="{% url 'mfa:admin_login' %}" class="text-muted" style="font-size: 0.9rem;">
                ‚Üê Back to Admin Login
              </a>
            </div>
          </div>
        </div>
      </div>
    </div>
    {% include 'partials/footer.html' %}
    <div class="modal fade" id="genericSecurityNotesModal" tabindex="-1" role="dialog" aria-labelledby="genericSecurityNotesLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title font-weight-bold" id="genericSecurityNotesLabel"><span class="brand-color">S</span>ecurity notes</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body text-left">
            <ul class="mb-0 pl-3" style="list-style: disc;">
              <li class="mb-1"><strong>Your Security Key</strong> is a short phrase we show here and in some emails. It should match.</li>
              <li class="mb-1"><strong>Keep codes private.</strong> We will never ask for your code or your Security Key.</li>
              <li class="mb-1"><strong>Only type codes on this website.</strong> Check the address bar and the lock (https) first.</li>
              <li class="mb-1"><strong>Verify the domain.</strong> Before entering a code, ensure the address bar shows our official domain.</li>
              <li class="mb-1"><strong>Not sure?</strong> Stop and contact support before continuing.</li>
            </ul>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-brand" data-dismiss="modal">Got it</button>
          </div>
        </div>
      </div>
    </div>
{% endblock %}
{% block extra_js %}
<script>
  (function(){
        var boxes = Array.prototype.slice.call(document.querySelectorAll('.otp-box'));
        if (boxes.length === 6) {
          boxes.forEach(function(b){ b.value = ''; });
          boxes[0].focus();
          boxes.forEach(function(box, idx){
            box.addEventListener('input', function(){
              var v = box.value.replace(/\D/g,'');
              box.value = v.slice(0,1);
              if (v && idx < 5) boxes[idx+1].focus();
            });
            box.addEventListener('keydown', function(e){
              if (e.key === 'Backspace' && !box.value && idx > 0) boxes[idx-1].focus();
            });
            box.addEventListener('paste', function(e){
              var text = (e.clipboardData || window.clipboardData).getData('text');
              if (!text) return;
              e.preventDefault();
              var digits = text.replace(/\D/g,'').slice(0,6).split('');
              for (var i=0;i<digits.length;i++){ boxes[i].value = digits[i]; }
              var hidden = document.getElementById('{{ form.code.id_for_label }}-hidden');
              hidden.value = boxes.map(function(b){return b.value||''}).join('');
              var form = document.getElementById('admin-otp-form');
              if (hidden.value.length === 6) form.requestSubmit();
            });
          });
        }
        var form = document.getElementById('admin-otp-form');
        if (form) {
          form.addEventListener('submit', function(e){
            var hidden = document.getElementById('{{ form.code.id_for_label }}-hidden');
            hidden.value = boxes.map(function(b){return (b.value||'').trim();}).join('');
            if (hidden.value.length !== 6) {
              e.preventDefault();
              boxes[0].focus();
            }
          });
        }
        var seconds = 45;
        var timerEl = document.getElementById('resend-timer');
        var link = document.getElementById('resend-link');
        var interval = setInterval(function(){
          seconds -= 1;
          if (timerEl) timerEl.textContent = seconds;
          if (seconds <= 0){
            clearInterval(interval);
            if (link){
              link.classList.remove('disabled');
              link.removeAttribute('aria-disabled');
              link.removeAttribute('tabindex');
              link.textContent = 'Resend code';
              var url = new URL(window.location.href);
              url.searchParams.set('resend', '1');
              link.setAttribute('href', url.toString());
            }
          }
        }, 1000);
  })();
</script>
{% endblock %}
